<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Guide Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; /* Hidden by default */ }
        .modal.active { display: flex; /* Show when active */ }
        .form-input, .form-textarea, .form-select {
            @apply mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400
                   focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500;
        }
        .btn { @apply font-medium py-2 px-4 rounded-lg shadow-md transition-colors duration-150; }
        .btn-primary { @apply bg-sky-600 text-white hover:bg-sky-700; }
        .btn-secondary { @apply bg-slate-200 text-slate-700 hover:bg-slate-300; }
        .btn-danger { @apply bg-red-500 text-white hover:bg-red-600; }
        .dynamic-list-item { @apply p-2 border border-slate-200 rounded-md mb-2 bg-slate-50; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">
    <div class="container mx-auto max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-700">Medication Guide Admin Panel</h1>
            <p class="text-slate-600 mt-2">Manage medications for the bronchoscopic guide.</p>
            <p class="text-xs text-slate-500 mt-1">User ID: <span id="userIdDisplay">Not signed in</span></p>
        </header>

        <div id="auth-status" class="mb-4 p-3 rounded-md text-center"></div>

        <div id="medicationModal" class="modal fixed inset-0 bg-slate-900 bg-opacity-75 items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h2 id="modalTitle" class="text-2xl font-semibold mb-6 text-slate-800">Add New Medication</h2>
                <form id="medicationForm">
                    <input type="hidden" id="medicationId">

                    <div class="mb-4">
                        <label for="medName" class="block text-sm font-medium text-slate-700">Medication Name*</label>
                        <input type="text" id="medName" class="form-input" required>
                    </div>

                    <fieldset class="border p-4 rounded-md mb-4">
                        <legend class="text-lg font-medium text-slate-700 px-2">Dosing Information</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div>
                                <label for="indication" class="block text-sm font-medium text-slate-700">Indication(s)</label>
                                <input type="text" id="indication" class="form-input">
                            </div>
                            <div>
                                <label for="dose" class="block text-sm font-medium text-slate-700">Dose (e.g., mg/kg, mcg/kg)</label>
                                <input type="text" id="dose" class="form-input">
                            </div>
                            <div>
                                <label for="concentration" class="block text-sm font-medium text-slate-700">Concentration (e.g., mg/mL)</label>
                                <input type="text" id="concentration" class="form-input">
                            </div>
                            <div>
                                <label for="volume" class="block text-sm font-medium text-slate-700">Volume to Administer</label>
                                <input type="text" id="volume" class="form-input">
                            </div>
                            <div>
                                <label for="maxDose" class="block text-sm font-medium text-slate-700">Max Dose</label>
                                <input type="text" id="maxDose" class="form-input">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="mechanism" class="block text-sm font-medium text-slate-700">Mechanism of Action</label>
                            <textarea id="mechanism" rows="3" class="form-textarea"></textarea>
                        </div>
                        <div class="mt-4">
                            <label for="notes" class="block text-sm font-medium text-slate-700">Notes</label>
                            <textarea id="notes" rows="3" class="form-textarea"></textarea>
                        </div>
                    </fieldset>

                    <fieldset class="border p-4 rounded-md mb-4">
                        <legend class="text-lg font-medium text-slate-700 px-2">CHOP Experiences</legend>
                        <div id="chopExperiencesContainer" class="mt-2 space-y-3">
                            </div>
                        <button type="button" id="addChopExperience" class="btn btn-secondary mt-3 text-sm">Add CHOP Experience</button>
                    </fieldset>

                    <fieldset class="border p-4 rounded-md mb-6">
                        <legend class="text-lg font-medium text-slate-700 px-2">References</legend>
                        <div id="referencesContainer" class="mt-2 space-y-3">
                            </div>
                        <button type="button" id="addReference" class="btn btn-secondary mt-3 text-sm">Add Reference</button>
                    </fieldset>

                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelModal" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Medication</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-slate-800">Medications</h2>
                <button id="addMedicationBtn" class="btn btn-primary">Add New Medication</button>
            </div>
            <div id="medicationsList" class="space-y-3">
                <p class="text-slate-500">Loading medications...</p>
            </div>
        </div>
    </div>

    <script type="module">
        // IMPORTANT: Replace with your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAnM-XtZGXGq0-gBHizE7XVS-uD_zQVxxI",
            authDomain: "bronchmeds.firebaseapp.com",
            projectId: "bronchmeds",
            storageBucket: "bronchmeds.firebasestorage.app",
            messagingSenderId: "82389119592",
            appId: "1:82389119592:web:1c1faa2e5e07da1d4c81dd",
            measurementId: "G-XBSWVE4RPK"
        };

        // If __firebase_config is defined (in Canvas environment), use it
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bronch-meds-app'; // Use __app_id if available

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInAnonymously, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            getDocs, 
            deleteDoc, 
            onSnapshot,
            query,
            orderBy // Added orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const medicationsCollectionRef = collection(db, `artifacts/${appId}/public/data/medications`); // Public collection

        // DOM Elements
        const medicationModal = document.getElementById('medicationModal');
        const modalTitle = document.getElementById('modalTitle');
        const medicationForm = document.getElementById('medicationForm');
        const cancelModalBtn = document.getElementById('cancelModal');
        const addMedicationBtn = document.getElementById('addMedicationBtn');
        const medicationsListDiv = document.getElementById('medicationsList');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const authStatusDiv = document.getElementById('auth-status');

        // Form fields
        const medIdInput = document.getElementById('medicationId');
        const medNameInput = document.getElementById('medName');
        const indicationInput = document.getElementById('indication');
        const doseInput = document.getElementById('dose');
        const concentrationInput = document.getElementById('concentration');
        const volumeInput = document.getElementById('volume');
        const maxDoseInput = document.getElementById('maxDose');
        const mechanismInput = document.getElementById('mechanism');
        const notesInput = document.getElementById('notes');
        const chopExperiencesContainer = document.getElementById('chopExperiencesContainer');
        const referencesContainer = document.getElementById('referencesContainer');
        const addChopExperienceBtn = document.getElementById('addChopExperience');
        const addReferenceBtn = document.getElementById('addReference');

        let currentUserId = null; // To store the current user's ID

        // Firebase Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                authStatusDiv.textContent = "Successfully signed in.";
                authStatusDiv.className = "mb-4 p-3 rounded-md text-center bg-green-100 text-green-700";
                console.log("User signed in:", currentUserId);
                loadMedications(); // Load medications once authenticated
            } else {
                currentUserId = null;
                userIdDisplay.textContent = "Not signed in";
                authStatusDiv.textContent = "Not signed in. Attempting anonymous sign-in...";
                authStatusDiv.className = "mb-4 p-3 rounded-md text-center bg-yellow-100 text-yellow-700";
                console.log("User not signed in. Attempting anonymous sign-in for admin page (consider proper auth).");
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                    authStatusDiv.textContent = `Sign-in failed: ${error.message}`;
                    authStatusDiv.className = "mb-4 p-3 rounded-md text-center bg-red-100 text-red-700";
                }
            }
        });


        // --- Dynamic Form Field Functions ---
        function createChopExperienceField(data = { indication: '', experience: '' }) {
            const div = document.createElement('div');
            div.className = 'dynamic-list-item grid grid-cols-1 gap-2';
            div.innerHTML = `
                <input type="text" placeholder="Indication" value="${data.indication}" class="form-input chop-indication">
                <textarea placeholder="Experience" rows="2" class="form-textarea chop-experience">${data.experience}</textarea>
                <button type="button" class="btn btn-danger btn-sm remove-item-btn w-full md:w-auto">Remove Experience</button>
            `;
            div.querySelector('.remove-item-btn').addEventListener('click', () => div.remove());
            chopExperiencesContainer.appendChild(div);
        }

        function createReferenceField(data = { text: '', link: '', takeaway: '' }) {
            const div = document.createElement('div');
            div.className = 'dynamic-list-item grid grid-cols-1 gap-2';
            div.innerHTML = `
                <input type="text" placeholder="Reference Text" value="${data.text}" class="form-input ref-text">
                <input type="url" placeholder="Link (optional)" value="${data.link}" class="form-input ref-link">
                <textarea placeholder="Key Takeaway" rows="2" class="form-textarea ref-takeaway">${data.takeaway}</textarea>
                <button type="button" class="btn btn-danger btn-sm remove-item-btn w-full md:w-auto">Remove Reference</button>
            `;
            div.querySelector('.remove-item-btn').addEventListener('click', () => div.remove());
            referencesContainer.appendChild(div);
        }

        addChopExperienceBtn.addEventListener('click', () => createChopExperienceField());
        addReferenceBtn.addEventListener('click', () => createReferenceField());

        // --- Modal Control ---
        function openModal(medication = null) {
            medicationForm.reset();
            chopExperiencesContainer.innerHTML = '';
            referencesContainer.innerHTML = '';
            medIdInput.value = '';

            if (medication) {
                modalTitle.textContent = 'Edit Medication';
                medIdInput.value = medication.id;
                medNameInput.value = medication.name;
                // Dosing Info
                indicationInput.value = medication.dosingInfo?.indication || '';
                doseInput.value = medication.dosingInfo?.doseMgPerKg || ''; // Field name mismatch, using existing form ID
                concentrationInput.value = medication.dosingInfo?.concentrationMgPerMl || '';
                volumeInput.value = medication.dosingInfo?.volumeMlPerKg || '';
                maxDoseInput.value = medication.dosingInfo?.maxDoseMg || '';
                mechanismInput.value = medication.dosingInfo?.mechanism || '';
                notesInput.value = medication.dosingInfo?.notes || '';

                // CHOP Experiences
                (medication.chopExperiences || []).forEach(createChopExperienceField);
                // References
                (medication.references || []).forEach(createReferenceField);

            } else {
                modalTitle.textContent = 'Add New Medication';
                // Add one empty field for experience and reference by default for new meds
                createChopExperienceField();
                createReferenceField();
            }
            medicationModal.classList.add('active');
        }

        function closeModal() {
            medicationModal.classList.remove('active');
        }

        addMedicationBtn.addEventListener('click', () => openModal());
        cancelModalBtn.addEventListener('click', closeModal);

        // --- CRUD Operations ---
        medicationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) {
                alert("You must be signed in to save medications.");
                return;
            }

            const id = medIdInput.value;
            const name = medNameInput.value.trim();
            if (!name) {
                alert("Medication name is required.");
                return;
            }

            const medicationData = {
                name: name,
                sortName: name.toLowerCase(), // For case-insensitive sorting
                dosingInfo: {
                    indication: indicationInput.value.trim(),
                    doseMgPerKg: doseInput.value.trim(), // Corresponds to 'dose' ID
                    concentrationMgPerMl: concentrationInput.value.trim(),
                    volumeMlPerKg: volumeInput.value.trim(),
                    maxDoseMg: maxDoseInput.value.trim(),
                    mechanism: mechanismInput.value.trim(),
                    notes: notesInput.value.trim()
                },
                chopExperiences: Array.from(chopExperiencesContainer.children).map(item => ({
                    indication: item.querySelector('.chop-indication').value.trim(),
                    experience: item.querySelector('.chop-experience').value.trim()
                })).filter(exp => exp.indication || exp.experience), // Filter out empty ones
                references: Array.from(referencesContainer.children).map(item => ({
                    text: item.querySelector('.ref-text').value.trim(),
                    link: item.querySelector('.ref-link').value.trim(),
                    takeaway: item.querySelector('.ref-takeaway').value.trim()
                })).filter(ref => ref.text || ref.link || ref.takeaway) // Filter out empty ones
            };

            try {
                if (id) { // Editing existing
                    const medDocRef = doc(medicationsCollectionRef, id);
                    await setDoc(medDocRef, medicationData);
                    console.log("Medication updated:", id);
                } else { // Adding new
                    // For simplicity, using medication name as ID. Ensure it's unique or use Firestore auto-IDs.
                    // Using Firestore auto-generated ID is generally safer for `addDoc`.
                    // If using name as ID, check for existence first or use setDoc with doc(collection, name).
                    // For this example, let's use auto-generated IDs.
                    const docRef = await addDoc(medicationsCollectionRef, medicationData);
                    console.log("Medication added with ID:", docRef.id);
                }
                closeModal();
                // loadMedications(); // onSnapshot will handle updates
            } catch (error) {
                console.error("Error saving medication: ", error);
                alert(`Error saving medication: ${error.message}`);
            }
        });

        async function deleteMedication(id) {
            if (!currentUserId) {
                alert("You must be signed in to delete medications.");
                return;
            }
            if (confirm("Are you sure you want to delete this medication?")) {
                try {
                    const medDocRef = doc(medicationsCollectionRef, id);
                    await deleteDoc(medDocRef);
                    console.log("Medication deleted:", id);
                    // loadMedications(); // onSnapshot will handle updates
                } catch (error) {
                    console.error("Error deleting medication: ", error);
                    alert(`Error deleting medication: ${error.message}`);
                }
            }
        }

        // --- Load and Display Medications ---
        function renderMedications(meds) {
            medicationsListDiv.innerHTML = ''; // Clear current list
            if (meds.length === 0) {
                medicationsListDiv.innerHTML = '<p class="text-slate-500">No medications found. Add some!</p>';
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'space-y-3';
            meds.forEach(med => {
                const li = document.createElement('li');
                li.className = 'p-4 bg-white border border-slate-200 rounded-lg shadow-sm flex justify-between items-center';
                li.innerHTML = `
                    <span class="text-lg font-medium text-slate-700">${med.name}</span>
                    <div class="space-x-2">
                        <button class="btn btn-secondary btn-sm edit-btn">Edit</button>
                        <button class="btn btn-danger btn-sm delete-btn">Delete</button>
                    </div>
                `;
                li.querySelector('.edit-btn').addEventListener('click', () => openModal(med));
                li.querySelector('.delete-btn').addEventListener('click', () => deleteMedication(med.id));
                ul.appendChild(li);
            });
            medicationsListDiv.appendChild(ul);
        }

        function loadMedications() {
            if (!auth.currentUser) {
                console.log("User not authenticated, cannot load medications yet.");
                medicationsListDiv.innerHTML = '<p class="text-slate-500">Please sign in to manage medications.</p>';
                return;
            }
            console.log("Setting up onSnapshot listener for medications...");
            const q = query(medicationsCollectionRef, orderBy("sortName")); // Order by sortName

            onSnapshot(q, (snapshot) => {
                const meds = [];
                snapshot.forEach(doc => {
                    meds.push({ id: doc.id, ...doc.data() });
                });
                console.log("Medications loaded/updated:", meds.length);
                renderMedications(meds);
            }, (error) => {
                console.error("Error fetching medications: ", error);
                medicationsListDiv.innerHTML = `<p class="text-red-500">Error loading medications: ${error.message}</p>`;
            });
        }
        
        // Initial attempt to load medications will be triggered by onAuthStateChanged
    </script>
</body>
</html>
